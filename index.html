<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scuole Primarie Padova - Analisi Distanze e Raggiungibilità 7:50</title>
    <meta name="description" content="Analizza distanze, tempi di percorrenza, mezzi pubblici e raggiungibilità entro le 7:50 per le scuole primarie di Padova e provincia">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #dc2626 0%, #991b1b 100%);
            color: white;
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 25px rgba(220, 38, 38, 0.3);
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }

        .critical-alert {
            background: rgba(254, 226, 226, 0.3);
            border: 2px solid rgba(254, 226, 226, 0.8);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.2);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            width: 100%;
        }

        .file-input-wrapper:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.8);
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .upload-text {
            font-size: 1.1rem;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-success {
            background: rgba(34, 197, 94, 0.2);
            border: 1px solid rgba(34, 197, 94, 0.5);
            color: #ffffff;
        }

        .status-error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ffffff;
        }

        .info-box {
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .info-box h3 {
            margin-bottom: 10px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            margin: 5px 0;
            padding-left: 15px;
            position: relative;
        }

        .info-box li::before {
            content: "•";
            position: absolute;
            left: 0;
            color: #fda4af;
            font-weight: bold;
        }

        .btn-primary {
            background: #ffffff;
            color: #991b1b;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-section {
            margin-top: 20px;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            height: 8px;
            margin-top: 15px;
            overflow: hidden;
        }

        .progress-fill {
            background: #fda4af;
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            font-weight: 500;
        }

        .schools-grid {
            display: grid;
            gap: 20px;
        }

        .school-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .school-card.reachable {
            border: 2px solid #10b981;
        }

        .school-card.not-reachable {
            border: 2px solid #ef4444;
            background: #fef2f2;
        }

        .school-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .school-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
            gap: 20px;
        }

        .school-info h3 {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
            line-height: 1.3;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .school-info p {
            color: #6b7280;
            margin-bottom: 12px;
        }

        .badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-rank { background: #dbeafe; color: #1e40af; }
        .badge-excellent { background: #d1fae5; color: #065f46; }
        .badge-good { background: #dbeafe; color: #1e40af; }
        .badge-fair { background: #fef3c7; color: #92400e; }
        .badge-poor { background: #fee2e2; color: #991b1b; }
        .badge-reachable { background: #d1fae5; color: #065f46; }
        .badge-not-reachable { background: #fee2e2; color: #991b1b; }

        .distance-display {
            text-align: right;
        }

        .distance-number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 2px;
        }

        .distance-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .distance-green { color: #059669; }
        .distance-yellow { color: #d97706; }
        .distance-orange { color: #ea580c; }
        .distance-red { color: #dc2626; }

        .time-section {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .time-section h4 {
            color: #0369a1;
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .time-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .time-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-item .time-value {
            font-weight: 600;
            color: #1f2937;
        }

        .time-item .time-status {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .time-status.feasible {
            background: #d1fae5;
            color: #065f46;
        }

        .time-status.not-feasible {
            background: #fee2e2;
            color: #991b1b;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 20px;
        }

        .metric {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .metric-icon.car { background: #dbeafe; color: #1e40af; }
        .metric-icon.bus { background: #d1fae5; color: #065f46; }
        .metric-icon.walk { background: #fed7aa; color: #ea580c; }

        .metric-content h4 {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 2px;
            font-weight: 500;
        }

        .metric-content p {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 2px;
        }

        .metric-content small {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .alert {
            margin-top: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-critical {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .empty-state {
            background: white;
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 10px;
        }

        .empty-state p {
            color: #6b7280;
            margin-bottom: 20px;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }

        .highlight-box {
            background: #fee2e2;
            border: 2px solid #ef4444;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .highlight-box strong {
            color: #991b1b;
        }

        .footer {
            text-align: center;
            padding: 30px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            margin-top: 50px;
        }

        @media (max-width: 768px) {
            .container { padding: 15px; }
            .header { padding: 20px; }
            .header h1 { font-size: 2rem; flex-direction: column; text-align: center; gap: 10px; }
            .school-header { flex-direction: column; gap: 15px; }
            .distance-display { text-align: left; }
            .metrics-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .time-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>
                🏫 Scuole Primarie Padova e Provincia
            </h1>
            <p>Analisi distanze, mezzi pubblici e raggiungibilità entro le 7:50 da via Giovanni d'Alemagna 12, 35134 Padova</p>
            
            <div class="critical-alert">
                <span style="font-size: 1.2rem;">🚨</span>
                <strong>VINCOLO CRITICO: Arrivo entro le 7:50 dal lunedì al venerdì</strong>
            </div>
            
            <!-- Sezione caricamento file -->
            <div class="upload-section">
                <h3>📂 Carica il file Excel delle scuole</h3>
                
                <div class="file-input-wrapper" onclick="document.getElementById('fileInput').click()">
                    <input type="file" id="fileInput" accept=".xlsx,.xls" />
                    <div class="upload-text">
                        📄 Clicca qui per caricare il file Excel
                    </div>
                    <div class="upload-subtext">
                        Supporta file .xlsx e .xls • Max 10MB
                    </div>
                </div>
                
                <div id="uploadStatus"></div>
            </div>

            <div class="info-box">
                <h3>📍 Come funziona l'analisi</h3>
                <ul>
                    <li><strong>🎯 VINCOLO CRITICO:</strong> Tutte le scuole devono essere raggiungibili entro le 7:50 dal lunedì al venerdì</li>
                    <li><strong>Caricamento Excel:</strong> Legge automaticamente il file e filtra le scuole primarie</li>
                    <li><strong>Distanze:</strong> Calcolate in linea d'aria (distanza reale sarà del 20-30% maggiore)</li>
                    <li><strong>Tempi auto:</strong> Stimati considerando traffico urbano/extraurbano dell'ora di punta</li>
                    <li><strong>Mezzi pubblici:</strong> Verificati orari mattutini (primi mezzi dalle 6:00)</li>
                    <li><strong>Orari partenza:</strong> Calcolati per arrivare entro le 7:50 con 10 min di margine</li>
                    <li><strong>Tempi a piedi:</strong> Dalle fermate alle scuole, basati su dati locali</li>
                </ul>
            </div>

            <button class="btn-primary" onclick="analyzeSchools()" id="analyzeBtn" disabled>
                🧮 Carica prima un file Excel
            </button>

            <div id="progressSection" style="display: none;" class="progress-section">
                <div id="progressText" style="color: rgba(255, 255, 255, 0.9); font-weight: 500; margin-top: 10px;">Preparazione...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
        </div>

        <!-- Statistiche -->
        <div id="statsContainer" style="display: none;">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" style="color: #6b7280;" id="totalSchools">0</div>
                    <div class="stat-label">Scuole totali</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #059669;" id="reachableSchools">0</div>
                    <div class="stat-label">Raggiungibili 7:50</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #dc2626;" id="notReachableSchools">0</div>
                    <div class="stat-label">NON raggiungibili</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #1e40af;" id="within5km">0</div>
                    <div class="stat-label">Entro 5 km</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #d97706;" id="excellentTransit">0</div>
                    <div class="stat-label">Mezzi ottimi</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ea580c;" id="longWalk">0</div>
                    <div class="stat-label">Cammino >10 min</div>
                </div>
            </div>
        </div>

        <!-- Lista scuole -->
        <div id="schoolsContainer"></div>

        <!-- Stato iniziale -->
        <div id="emptyState" class="empty-state">
            <div class="empty-state-icon">📂</div>
            <h3>Carica il file Excel delle scuole</h3>
            <p>
                Carica il file Excel contenente l'elenco delle scuole primarie di Padova e provincia 
                per iniziare l'analisi automatica di distanze, tempi di percorrenza, mezzi pubblici e 
                raggiungibilità entro le 7:50 del mattino.
            </p>
            <div class="highlight-box">
                <strong>🚨 VINCOLO CRITICO:</strong><br/>
                L'analisi evidenzierà quali scuole sono raggiungibili entro le <strong>7:50 del mattino</strong> 
                da lunedì a venerdì, considerando sia auto che mezzi pubblici.
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>🏫 <strong>Scuole Primarie Padova</strong> - Analisi distanze, mezzi pubblici e raggiungibilità 7:50</p>
            <p>Sviluppato con ❤️ per aiutare nella scelta della scuola ideale</p>
        </div>
    </div>

    <script>
        // Coordinate di partenza: via Giovanni d'Alemagna 12, 35134 Padova
        const coordPartenza = { lat: 45.4042, lng: 11.8828 };
        
        let scuolePrimarie = [];
        let scuoleAnalizzate = [];
        let fileLoaded = false;
        let isLoading = false;

        // Database coordinate comuni
        const coordComuni = {
            'PADOVA': { lat: 45.4064, lng: 11.8768, mezziPubblici: 'Ottimi', tempoMezzi: '10-25 min', cammino: '3-5 min' },
            'ABANO TERME': { lat: 45.3583, lng: 11.7917, mezziPubblici: 'Buoni', tempoMezzi: '25-35 min', cammino: '5 min' },
            'ALBIGNASEGO': { lat: 45.3500, lng: 11.8667, mezziPubblici: 'Ottimi', tempoMezzi: '18-28 min', cammino: '5 min' },
            'CADONEGHE': { lat: 45.4167, lng: 11.9167, mezziPubblici: 'Ottimi', tempoMezzi: '15-25 min', cammino: '3 min' },
            'CAMPOSAMPIERO': { lat: 45.5667, lng: 11.9333, mezziPubblici: 'Buoni', tempoMezzi: '40-55 min', cammino: '5 min' },
            'CITTADELLA': { lat: 45.6472, lng: 11.7806, mezziPubblici: 'Buoni', tempoMezzi: '45-60 min', cammino: '8 min' },
            'CONSELVE': { lat: 45.2394, lng: 11.8681, mezziPubblici: 'Disponibili', tempoMezzi: '35-50 min', cammino: '5 min' },
            'CORREZZOLA': { lat: 45.2167, lng: 12.0833, mezziPubblici: 'Limitati', tempoMezzi: '50-70 min', cammino: '8 min' },
            'CURTAROLO': { lat: 45.5167, lng: 11.7833, mezziPubblici: 'Disponibili', tempoMezzi: '35-50 min', cammino: '10 min' },
            'DUE CARRARE': { lat: 45.2667, lng: 11.8333, mezziPubblici: 'Disponibili', tempoMezzi: '40-55 min', cammino: '10 min' },
            'ESTE': { lat: 45.2289, lng: 11.6578, mezziPubblici: 'Disponibili', tempoMezzi: '50-70 min', cammino: '8 min' },
            'LEGNARO': { lat: 45.3500, lng: 11.9667, mezziPubblici: 'Buoni', tempoMezzi: '25-35 min', cammino: '5 min' },
            'LOREGGIA': { lat: 45.5833, lng: 11.9333, mezziPubblici: 'Disponibili', tempoMezzi: '40-55 min', cammino: '5 min' },
            'MASERA\' DI PADOVA': { lat: 45.2833, lng: 11.8833, mezziPubblici: 'Buoni', tempoMezzi: '30-40 min', cammino: '8 min' },
            'MESTRINO': { lat: 45.4000, lng: 11.8000, mezziPubblici: 'Buoni', tempoMezzi: '25-35 min', cammino: '8 min' },
            'MONTAGNANA': { lat: 45.2317, lng: 11.4658, mezziPubblici: 'Limitati', tempoMezzi: '60-90 min', cammino: '10 min' },
            'MONTEGROTTO TERME': { lat: 45.3333, lng: 11.7833, mezziPubblici: 'Buoni', tempoMezzi: '30-40 min', cammino: '5 min' },
            'NOVENTA PADOVANA': { lat: 45.3833, lng: 11.8833, mezziPubblici: 'Ottimi', tempoMezzi: '15-20 min', cammino: '3 min' },
            'PIAZZOLA SUL BRENTA': { lat: 45.5500, lng: 11.7833, mezziPubblici: 'Buoni', tempoMezzi: '35-50 min', cammino: '5 min' },
            'PIOVE DI SACCO': { lat: 45.2972, lng: 12.0333, mezziPubblici: 'Disponibili', tempoMezzi: '35-50 min', cammino: '5 min' },
            'PONTE SAN NICOLO\'': { lat: 45.3833, lng: 11.9000, mezziPubblici: 'Buoni', tempoMezzi: '20-30 min', cammino: '5 min' },
            'RUBANO': { lat: 45.4167, lng: 11.8167, mezziPubblici: 'Ottimi', tempoMezzi: '20-30 min', cammino: '5 min' },
            'SAN GIORGIO DELLE PERTICHE': { lat: 45.5167, lng: 11.9500, mezziPubblici: 'Buoni', tempoMezzi: '30-45 min', cammino: '8 min' },
            'SANT\'ANGELO DI PIOVE DI SACCO': { lat: 45.2917, lng: 12.0333, mezziPubblici: 'Disponibili', tempoMezzi: '35-45 min', cammino: '3 min' },
            'SAONARA': { lat: 45.3667, lng: 11.9333, mezziPubblici: 'Buoni', tempoMezzi: '25-35 min', cammino: '5 min' },
            'SELVAZZANO DENTRO': { lat: 45.3791, lng: 11.8041, mezziPubblici: 'Buoni', tempoMezzi: '25-35 min', cammino: '8 min' },
            'SOLESINO': { lat: 45.2500, lng: 11.7833, mezziPubblici: 'Disponibili', tempoMezzi: '45-60 min', cammino: '5 min' },
            'TEOLO': { lat: 45.3500, lng: 11.6833, mezziPubblici: 'Disponibili', tempoMezzi: '35-50 min', cammino: '10 min' },
            'TRIBANO': { lat: 45.1753, lng: 11.8544, mezziPubblici: 'Disponibili', tempoMezzi: '45-60 min', cammino: '5 min' },
            'VIGONZA': { lat: 45.4167, lng: 11.9333, mezziPubblici: 'Ottimi', tempoMezzi: '20-30 min', cammino: '5 min' },
            'VIGODARZERE': { lat: 45.4500, lng: 11.9000, mezziPubblici: 'Ottimi', tempoMezzi: '20-30 min', cammino: '5 min' }
        };

        // Gestione upload file
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                showStatus('Per favore carica un file Excel (.xlsx o .xls)', 'error');
                return;
            }

            setLoading(true);
            try {
                await processExcelFile(file);
                updateAnalyzeButton();
            } catch (error) {
                console.error('Errore nel caricamento:', error);
                showStatus(`Errore nel caricamento del file: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        }

        async function processExcelFile(file) {
            showProgress('Caricamento file Excel...');
            
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
            
            // Filtra le scuole primarie (codici che iniziano con PDEE)
            const dataRows = jsonData.slice(1); // Salta header
            const scuolePrimarieFiltrate = dataRows.filter(row => {
                const codiceMiur = row[4];
                return codiceMiur && typeof codiceMiur === 'string' && codiceMiur.startsWith('PDEE');
            });

            showProgress('Geocodifica indirizzi...');
            
            // Mappa i dati e aggiunge coordinate approssimative
            scuolePrimarie = scuolePrimarieFiltrate.map(row => ({
                provincia: row[0],
                codiceComune: row[1], 
                codiceScuola: row[2],
                comune: row[3],
                codiceMiur: row[4],
                nomeIstituto: row[5],
                indirizzo: row[6],
                localita: row[7],
                ...getCoordinateApprossimative(row[3], row[5])
            }));

            fileLoaded = true;
            showStatus(`File caricato! Trovate ${scuolePrimarie.length} scuole primarie`, 'success');
            hideProgress();
        }

        function getCoordinateApprossimative(comune, nomeScuola) {
            const coordBase = coordComuni[comune.toUpperCase()] || coordComuni['PADOVA'];
            
            // Aggiungi piccola variazione casuale per scuole nello stesso comune
            const latVariation = (Math.random() - 0.5) * 0.01;
            const lngVariation = (Math.random() - 0.5) * 0.01;
            
            return {
                lat: coordBase.lat + latVariation,
                lng: coordBase.lng + lngVariation,
                mezziPubblici: coordBase.mezziPubblici,
                tempoMezzi: coordBase.tempoMezzi,
                cammino: coordBase.cammino
            };
        }

        function calcolaDistanza(lat1, lng1, lat2, lng2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function calcolaTempoAuto(distanzaKm) {
            // Velocità media ridotta per traffico dell'ora di punta mattutina
            const velocitaMedia = distanzaKm < 5 ? 20 : distanzaKm < 15 ? 30 : 40;
            const tempoOre = distanzaKm / velocitaMedia;
            const tempoMinuti = Math.round(tempoOre * 60);
            
            if (tempoMinuti < 60) {
                return `${tempoMinuti} min`;
            } else {
                const ore = Math.floor(tempoMinuti / 60);
                const minuti = tempoMinuti % 60;
                return `${ore}h ${minuti}min`;
            }
        }

        function getMezziPubbliciInfo(mezziPubblici) {
            const info = {
                "Ottimi": { available: true, quality: "excellent", badge: "badge-excellent" },
                "Buoni": { available: true, quality: "good", badge: "badge-good" },
                "Disponibili": { available: true, quality: "fair", badge: "badge-fair" },
                "Limitati": { available: false, quality: "poor", badge: "badge-poor" }
            };
            return info[mezziPubblici] || info["Limitati"];
        }

        function getDistanceColor(distance) {
            if (distance <= 3) return 'distance-green';
            if (distance <= 8) return 'distance-yellow';
            if (distance <= 15) return 'distance-orange';
            return 'distance-red';
        }

        function calcolaRaggiungibilita750(durationCarValue, durationTransitValue, transitAvailable) {
            const TARGET_TIME = 7 * 60 + 50; // 7:50 in minuti
            const BUFFER_TIME = 10; // 10 minuti di margine
            
            // Verifica auto
            const carDepartureTime = TARGET_TIME - durationCarValue;
            const reachableByCar = carDepartureTime >= 6 * 60; // Non prima delle 6:00
            
            // Verifica mezzi pubblici (considerando orari mattutini)
            let reachableByTransit = false;
            let transitDepartureTime = null;
            
            if (transitAvailable) {
                // I mezzi pubblici iniziano generalmente alle 5:30-6:00
                const firstBusTime = 6 * 60; // 6:00
                transitDepartureTime = TARGET_TIME - durationTransitValue;
                reachableByTransit = transitDepartureTime >= firstBusTime;
            }
            
            return {
                reachableByCar,
                reachableByTransit,
                carDepartureTime: formatTime(carDepartureTime),
                transitDepartureTime: transitDepartureTime ? formatTime(transitDepartureTime) : null,
                overallReachable: reachableByCar || reachableByTransit
            };
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        async function analyzeSchools() {
            if (!fileLoaded || scuolePrimarie.length === 0) {
                showStatus('Carica prima un file Excel delle scuole', 'error');
                return;
            }
            
            setLoading(true);
            scuoleAnalizzate = [];
            hideEmptyState();

            for (let i = 0; i < scuolePrimarie.length; i++) {
                const scuola = scuolePrimarie[i];
                showProgress(`Calcolando ${scuola.nomeIstituto} (${i + 1}/${scuolePrimarie.length})`);

                const distanzaKm = calcolaDistanza(
                    coordPartenza.lat, coordPartenza.lng,
                    scuola.lat, scuola.lng
                );

                const tempoAuto = calcolaTempoAuto(distanzaKm);
                const mezziInfo = getMezziPubbliciInfo(scuola.mezziPubblici);
                const cammino = parseInt(scuola.cammino.match(/\d+/)[0]);

                const schoolData = {
                    ...scuola,
                    distanceKm: parseFloat(distanzaKm.toFixed(1)),
                    durationCar: tempoAuto,
                    durationCarValue: parseInt(tempoAuto.match(/\d+/)[0]),
                    mezziInfo,
                    durationTransitValue: parseInt(scuola.tempoMezzi.split('-')[1]) || 60,
                    walkingTimeFromTransit: cammino,
                    durationWalking: `${Math.round(distanzaKm * 12)} min`
                };

                // Calcola raggiungibilità entro le 7:50
                schoolData.raggiungibilita = calcolaRaggiungibilita750(
                    schoolData.durationCarValue,
                    schoolData.durationTransitValue,
                    schoolData.mezziInfo.available
                );

                scuoleAnalizzate.push(schoolData);
                updateProgress((i + 1) / scuolePrimarie.length * 100);
                await new Promise(resolve => setTimeout(resolve, 50));
            }

            // Ordina per raggiungibilità 7:50 prima, poi per distanza
            scuoleAnalizzate.sort((a, b) => {
                if (a.raggiungibilita.overallReachable && !b.raggiungibilita.overallReachable) return -1;
                if (!a.raggiungibilita.overallReachable && b.raggiungibilita.overallReachable) return 1;
                return a.distanceKm - b.distanceKm;
            });

            renderResults();
            setLoading(false);
            hideProgress();
            updateAnalyzeButton();
        }

        function renderResults() {
            renderStats();
            renderSchools();
        }

        function renderStats() {
            document.getElementById('statsContainer').style.display = 'block';
            document.getElementById('totalSchools').textContent = scuoleAnalizzate.length;
            document.getElementById('reachableSchools').textContent = 
                scuoleAnalizzate.filter(s => s.raggiungibilita.overallReachable).length;
            document.getElementById('notReachableSchools').textContent = 
                scuoleAnalizzate.filter(s => !s.raggiungibilita.overallReachable).length;
            document.getElementById('within5km').textContent = 
                scuoleAnalizzate.filter(s => s.distanceKm <= 5).length;
            document.getElementById('excellentTransit').textContent = 
                scuoleAnalizzate.filter(s => s.mezziInfo.quality === "excellent").length;
            document.getElementById('longWalk').textContent = 
                scuoleAnalizzate.filter(s => s.walkingTimeFromTransit > 10 && s.mezziInfo.available).length;
        }

        function renderSchools() {
            const container = document.getElementById('schoolsContainer');
            container.innerHTML = '';

            scuoleAnalizzate.forEach((scuola, index) => {
                const card = createSchoolCard(scuola, index);
                container.appendChild(card);
            });
        }

        function createSchoolCard(scuola, index) {
            const div = document.createElement('div');
            div.className = `school-card ${scuola.raggiungibilita.overallReachable ? 'reachable' : 'not-reachable'}`;

            const alerts = [];
            if (!scuola.raggiungibilita.overallReachable) {
                alerts.push({
                    type: 'critical',
                    text: `🚨 CRITICO: Non raggiungibile entro le 7:50! ${
                        !scuola.raggiungibilita.reachableByCar && !scuola.raggiungibilita.reachableByTransit ? 
                        "Né in auto né con mezzi pubblici è possibile arrivare in tempo." :
                        !scuola.raggiungibilita.reachableByCar ? "Solo mezzi pubblici disponibili." :
                        "Solo auto disponibile per arrivare in tempo."
                    }`
                });
            }

            if (scuola.walkingTimeFromTransit > 10 && scuola.mezziInfo.available) {
                alerts.push({
                    type: 'warning',
                    text: `⚠️ ${scuola.walkingTimeFromTransit} minuti a piedi dalla fermata`
                });
            }

            if (scuola.distanceKm > 15) {
                alerts.push({
                    type: 'danger',
                    text: `🚨 Scuola molto distante: oltre 15 km da casa`
                });
            }

            div.innerHTML = `
                <div class="school-header">
                    <div class="school-info">
                        <h3>
                            ${scuola.nomeIstituto}
                            <span style="font-size: 1.5rem;">
                                ${scuola.raggiungibilita.overallReachable ? '✅' : '🚫'}
                            </span>
                        </h3>
                        <p>${scuola.indirizzo}, ${scuola.comune}</p>
                        <div class="badges">
                            <span class="badge badge-rank">#${index + 1}</span>
                            <span class="badge ${scuola.mezziInfo.badge}">${scuola.mezziPubblici}</span>
                            <span class="badge ${scuola.raggiungibilita.overallReachable ? 'badge-reachable' : 'badge-not-reachable'}">
                                ${scuola.raggiungibilita.overallReachable ? '✅ Raggiungibile 7:50' : '🚫 NON raggiungibile'}
                            </span>
                        </div>
                    </div>
                    <div class="distance-display">
                        <div class="distance-number ${getDistanceColor(scuola.distanceKm)}">
                            ${scuola.distanceKm} km
                        </div>
                        <div class="distance-label">in linea d'aria</div>
                    </div>
                </div>

                <div class="time-section">
                    <h4>⏰ Orari di partenza per arrivare entro le 7:50</h4>
                    <div class="time-grid">
                        <div class="time-item">
                            <span>🚗</span>
                            <div>
                                <div class="time-value">Auto: ${scuola.raggiungibilita.carDepartureTime}</div>
                                <div class="time-status ${scuola.raggiungibilita.reachableByCar ? 'feasible' : 'not-feasible'}">
                                    ${scuola.raggiungibilita.reachableByCar ? '✅ Fattibile' : '❌ Troppo presto'}
                                </div>
                            </div>
                        </div>
                        <div class="time-item">
                            <span>🚌</span>
                            <div>
                                <div class="time-value">Mezzi: ${scuola.raggiungibilita.transitDepartureTime || 'N/D'}</div>
                                <div class="time-status ${scuola.raggiungibilita.reachableByTransit ? 'feasible' : 'not-feasible'}">
                                    ${scuola.raggiungibilita.reachableByTransit ? '✅ Fattibile' : '❌ Non possibile'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="metrics-grid">
                    <div class="metric">
                        <div class="metric-icon car">🚗</div>
                        <div class="metric-content">
                            <h4>In auto</h4>
                            <p>${scuola.durationCar}</p>
                            <small>traffico ora di punta</small>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-icon bus">🚌</div>
                        <div class="metric-content">
                            <h4>Mezzi pubblici ${scuola.mezziInfo.available ? '✅' : '❌'}</h4>
                            <p>${scuola.tempoMezzi}</p>
                            <small>🚶‍♂️ + ${scuola.walkingTimeFromTransit} min a piedi</small>
                        </div>
                    </div>
                    <div class="metric">
                        <div class="metric-icon walk">🚶‍♂️</div>
                        <div class="metric-content">
                            <h4>Solo a piedi</h4>
                            <p>${scuola.durationWalking}</p>
                            <small>stimato</small>
                        </div>
                    </div>
                </div>

                ${alerts.map(alert => `
                    <div class="alert alert-${alert.type}">
                        ${alert.text}
                    </div>
                `).join('')}
            `;

            return div;
        }

        // Utility functions
        function showStatus(message, type) {
            const statusDiv = document.getElementById('uploadStatus');
            statusDiv.innerHTML = `
                <div class="status-message status-${type}">
                    ${type === 'success' ? '✅' : '❌'} ${message}
                </div>
            `;
        }

        function showProgress(text) {
            const progressSection = document.getElementById('progressSection');
            const progressText = document.getElementById('progressText');
            progressText.textContent = text;
            progressSection.style.display = 'block';
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            progressFill.style.width = `${percentage}%`;
        }

        function hideProgress() {
            document.getElementById('progressSection').style.display = 'none';
        }

        function setLoading(loading) {
            isLoading = loading;
            updateAnalyzeButton();
        }

        function updateAnalyzeButton() {
            const btn = document.getElementById('analyzeBtn');
            if (isLoading) {
                btn.textContent = '🧮 Analizzando...';
                btn.disabled = true;
            } else if (!fileLoaded) {
                btn.textContent = '📂 Carica prima un file Excel';
                btn.disabled = true;
            } else if (scuoleAnalizzate.length > 0) {
                btn.textContent = '✅ Analisi Completata - Ricalcola';
                btn.disabled = false;
            } else {
                btn.textContent = '🧮 Calcola Distanze e Tempi';
                btn.disabled = false;
            }
        }

        function hideEmptyState() {
            document.getElementById('emptyState').style.display = 'none';
        }

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App Scuole Primarie Padova con vincolo 7:50 caricata!');
        });
    </script>
</body>
</html>
